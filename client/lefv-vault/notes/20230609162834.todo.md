# [Install ActionRuntimes] https://c3energy.atlassian.net/browse/MDAPTS-253 | ActionRuntimes

## Get All ActionRuntime Dependencies

![[./lib/generate-conda-runtimes.md]]

## Failed Runtimes | Mon Jun 12 21:14:35 EDT 2023

```json

{
    "type": "C3Error",
    "id": "175.122",
    "key": "c3.engine.action.CondaActionRuntimeMethods_installRuntime",
    "cause": {
        "type": "C3Error",
        "id": "175.121",
        "key": "c3.love.util.OsUtil_err0",
        "template": "Error executing command: {}\n{}",
        "parameters": [
            "[/usr/local/share/c3/conda/bin/conda, env, create, -p, /usr/local/share/c3/condaEnvs/mdaPTS/dev/py-exmachina_1_0_0, -q, --file, /tmp/e631a17a-d287-4eba-a747-e3d71de3e645/requirements.yaml]",
            "Pip subprocess error:\n  Missing build requirements in pyproject.toml for multidict<7.0,>=4.5 from https://files.pythonhosted.org/packages/4a/15/bd620f7a6eb9aa5112c4ef93e7031bcd071e0611763d8e17706ef8ba65e0/multidict-6.0.4.tar.gz#sha256=3666906492efb76453c0e7b97f2cf459b0682e7402c0489a95484965dbc1da49 (from aiohttp!=4.0.0a0,!=4.0.0a1->s3fs>=2022.1.0->-r /tmp/e631a17a-d287-4eba-a747-e3d71de3e645/condaenv.1ty36d7c.requirements.txt (line 3)).\n  The project does not specify a build backend, and pip cannot fall back to setuptools without 'wheel'.\n  Failed building wheel for pyarrow\nCould not build wheels for pyarrow which use PEP 517 and cannot be installed directly\nCondaEnvException: Pip failed"
        ],
        "codes": [
            "NotClassified"
        ]
    },
    "template": "Failed during the creation of ActionRuntime '{}', a_step='{}', a_error='{}'",
    "parameters": [
        "Obj<ActionRuntime> [name=py-exmachina_1_0_0,id=py-exmachina_1_0_0]",
        "environment creation",
        "c3.love.exceptions.C3RuntimeException: Error executing command: [/usr/local/share/c3/conda/bin/conda, env, create, -p, /usr/local/share/c3/condaEnvs/mdaPTS/dev/py-exmachina_1_0_0, -q, --file, /tmp/e631a17a-d287-4eba-a747-e3d71de3e645/requirements.yaml]\nPip subprocess error:\n  Missing build requirements in pyproject.toml for multidict<7.0,>=4.5 from https://files.pythonhosted.org/packages/4a/15/bd620f7a6eb9aa5112c4ef93e7031bcd071e0611763d8e17706ef8ba65e0/multidict-6.0.4.tar.gz#sha256=3666906492efb76453c0e7b97f2cf459b0682e7402c0489a95484965dbc1da49 (from aiohttp!=4.0.0a0,!=4.0.0a1->s3fs>=2022.1.0->-r /tmp/e631a17a-d287-4eba-a747-e3d71de3e645/condaenv.1ty36d7c.requirements.txt (line 3)).\n  The project does not specify a build backend, and pip cannot fall back to setuptools without 'wheel'.\n  Failed building wheel for pyarrow\nCould not build wheels for pyarrow which use PEP 517 and cannot be installed directly\nCondaEnvException: Pip failed"
    ],
    "codes": [
        "NotClassified"
    ]
}

```

## Tue Jun 13 16:26:03 EDT 2023 | Conda Patch Output

(base) bash-4.4# conda install -c conda-forge conda-forge-repodata-patches
Collecting package metadata (repodata.json): done
Solving environment: done


==> WARNING: A newer version of conda exists. <==
  current version: 4.9.2
  latest version: 23.5.0

Please update conda by running

    $ conda update -n base -c defaults conda



## Package Plan ##

  environment location: /usr/local/share/c3/conda

  added / updated specs:
    - conda-forge-repodata-patches


The following packages will be downloaded:

    package                    |            build
    ---------------------------|-----------------
    ca-certificates-2022.9.24  |       ha878542_0         150 KB  conda-forge
    certifi-2022.9.24          |     pyhd8ed1ab_0         155 KB  conda-forge
    conda-forge-repodata-patches-20221115.12.07.17|       hd8ed1ab_0         2.8 MB  conda-forge
    ------------------------------------------------------------
                                           Total:         3.1 MB

The following NEW packages will be INSTALLED:

  conda-forge-repod~ conda-forge/noarch::conda-forge-repodata-patches-20221115.12.07.17-hd8ed1ab_0

The following packages will be SUPERSEDED by a higher-priority channel:

  ca-certificates    pkgs/main::ca-certificates-2023.05.30~ --> conda-forge::ca-certificates-2022.9.24-ha878542_0
  certifi            pkgs/main/linux-64::certifi-2023.5.7-~ --> conda-forge/noarch::certifi-2022.9.24-pyhd8ed1ab_0

Proceed ([y]/n)? y

## Prepare Containers

- c3server container must be stopped.
- (note) c3server container will ideally be 'raised' as a new artifact \
  to prevent pollusion.
- (once c3server container runnintg) useful to validate mounts and \
  read/write access from/to docker/host.

## Add Conda Mounts to docker-compose.yml for c3server

```yml

      - ./mount-c3server/conda/condarc.yml:/usr/local/share/c3/conda/.condarc
      - ./mount-c3server/conda/c3-conda-channel/:/c3-conda-channel
      - ./mount-c3server/conda/c3-jupyter-channel/:/c3-jupyter-channel

```

## Edit `condarc` to Download bz2 Only

```yml

# offline: True
use_only_tar_bz2: True
#channels:
#  - c3-conda-channel
#custom_multichannels:
#  c3-conda-channel:
#    - file:///c3-conda-channel
#    - file:///c3-jupyter-channel
#default_channels:
#  - c3-conda-channel
# allow_other_channels: False
# restore_free_channel: False

```

## Raise `c3server`

`docker-compose up -d c3server`

## Connect to c3server

```bash
docker exec -it c3server /bin/bash
```

## Validate Mounts and Conda environment

Mounts can be validated as follows:

```bash
alias _dt="date +%Y_%m_%d_%H%M"
ls /
echo "Hello World" > /c3-conda-channel/`_dt`_hello_conda_channel.txt
echo "Hello World" > /c3-jupyter-channel/`_dt`_hello_jupyter_channel.txt
```

The files created should be visible and modifiable by the host at the local mount path.

Conda environment can be validated as follows:

```bash

> printenv | grep conda
# example output
CONDA_EXE=/usr/local/share/c3/conda/bin/conda
OLDPWD=/c3-conda-channel
CONDA_PREFIX=/usr/local/share/c3/conda
CONDA_PYTHON_EXE=/usr/local/share/c3/conda/bin/python
PATH=/usr/local/share/c3/conda/bin:/usr/local/share/c3/conda/condabin:/c3/scripts:/usr/local/go/bin:/usr/local/sbin:.:/usr/local/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/go/bin
...

> conda env list

# example output
base                  *  /usr/local/share/c3/conda
c3-r                     /usr/local/share/c3/conda/envs/c3-r

...

> cat /usr/local/share/c3/conda/.condarc

# example output

# offline: True
use_only_tar_bz2: True
#channels:
#  - c3-conda-channel
#custom_multichannels:
#  c3-conda-channel:
#    - file:///c3-conda-channel
#    - file:///c3-jupyter-channel
#default_channels:
#  - c3-conda-channel
# allow_other_channels: False
# restore_free_channel: False

```

The `condarc` will be modifiable from both the container/host in real time.

## Provision Relevant Application

Example:

  `c3 prov tag -t mdaPTS:dev -c mdaPTS -u BA:BA -e http://mdapts:8080 -a $PWD`

## Install all ActionRuntimes

```js

// set c3fs
var origFSDefault = FileSystemConfig.make().getConfig().default;
FileSystemConfig.make().setDefault(FileSystemScheme.c3fs, ConfigOverride.TAG);
var origDefaultMount = FileSystem.mounts()['DEFAULT'];
var origExmfilesMount = FileSystem.mounts()['EXMFILES'];

// prevent config from timing out
var config = CondaActionRuntimeConfig.make().getConfig();
config.setConfigValue("envInstallationTimeoutSeconds", 9999);

// get all Python runtimes
var rts = TagMetadataStore.runtimes('Python');
// install runtimes
for (var rt in rts) {
  try {
    ActionRuntime.forName(rt).ensureInstalled();
  } catch (e) {
    console.log(e); // note any failures
  }
}

```

## **Optional**

Save c3server container as image to preserve container state.

```bash

# saving image artifact
# docker ${container_hash} <image_name_desired>:<tag>
# example
docker abcd1234 my_saved_runtimes:1.0.0

```

Export docker container for persistence outside of docker runtime.

```bash

# docker export <container_name_or_id> > <output_file.tar>
# example
docker save abcd1234 -o my_saved_runtimes.tar

```

Importing saved image can later be done as:

```bash

docker load -i my_saved_runtimes.tar

```

The saved image can then be reference as the reference image in a docker-compose.yml.

```md
services:
    c3server:
    
